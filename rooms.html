<html>
<head>
	<style type="text/css">
	#room div{
		border: solid 3px;
		width: 100px;
		height: 100px;
		margin: 3px;
	}
	#roomsList div {
/*		border: solid 2px;
		border-radius: 5px;
		margin: 10px;
		padding: 15px;
		width: 500px;
		font-size: 20px;*/
		cursor: pointer;
	}
	</style>
	<title>rooms</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<link rel="stylesheet" type="text/css" href="css/statusBar.css">

	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
  	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  	<script type="text/javascript" src="js/custom.js"></script>
</head>
<body>
<div>
	<nav class="navbar navbar-default navbar-top">
		<div class="container-fluid">
			<div class="navbar-header"> 
				<a class="navbar-brand" href="index.html">Главная</a>
			</div>
			<ul class="nav navbar-nav">
				<li id="reg"><a href="registration.html">Регистрация</a></li>
				<li id="nut"><a href="nutrition.html">Питание</a></li>
				<li id="room"><a href="rooms.html">Поселение</a></li>
				<li id="bage"><a href="makebage.html">Сделать Бэйдж</a></li>
				<li id="userInfo"><a href="info.html">Информация о юзере</a></li> 
				<li id="infoTable"><a href="infoTable.html">Таблица</a></li>
			</ul>
		</div>
	</nav>	
</div>	

<div style="margin-left:100px"> 						
	<div id="events">
		<h3>Мероприятие: <b>-----</b></h3> 
	</div>
</div>

<div style="margin-left:100px">
	<div id="price_app">
		<h3>Цена: <b>-</b></h3> 
	</div>
</div>

<br>

<div class="container">
	<form role="form" action="" method="post" class="col-md-6">

		<div class="form-group">
			<label for="lfm">ФИО</label>
			<br>
	    	<input id="lfm" class="ui-widget" type="text" class="form-control" name="lfm" />
	    </div>

	    <div class="form-group">
			<label for="start">Въезд</label>
			<br>
	    	<input id="start" class="ui-widget" type="date" class="form-control" name="start" />
	    </div>

	    <div class="form-group">
			<label for="end">Оътезд</label>
			<br>
	    	<input id="end" class="ui-widget" type="date" class="form-control" name="end" />
	    </div>

<!-- 	    <div class="form-group">
			<label for="price">Стоимость</label>
			<br>
	    	<input id="price" class="ui-widget" type="text" class="form-control" name="price" />
	    </div> -->
	    <!-- <input id="button" type="submit" name="submit" value="Submit" /> -->
		<button id="button" class="btn btn-default" type="button">Подтвердить!</button>
	</form>

	<div id="roomsList" class="col-md-6"></div>
</div>

<div id="roomsList">
</div>


<script type="text/javascript">
	var status = localStorage.getItem("status");
	paintBars(status, "room");
	putEvent();

	var fio = "";
	var LFM = new Array();
	var result = new Array();

	$(function() {
		fillFio();
		$( "#lfm" ).autocomplete({source: LFM}); 
		$("#button").on("click", function() {
			sendData();
		});

		//set today data ex. 2013-01-08
		setToday();

	
		$( "#event" ).on( "autocompleteselect", function( event, ui ) {
			localStorage.setItem("event", ui.item.value);							
		});

		if(e = localStorage.getItem("event"))
			$( "#event" ).val(e);
	});

	setInterval(function(){
		var d1 = $("#start").val();
		var d2 = $("#end").val();
		// console.log(d1);
		// console.log(d2);
		if(d1 && d2)
		{
			D1 = new Date(d1);
			D2 = new Date(d2);
			D = (D2-D1)/86400000;
			if(D < 0)
				$("#price_app b").html("Выберите правильные даты");
			else
				$("#price_app b").html(D * localStorage.getItem("price_app"));
		}
		else 
			$("#price_app b").html("-");
	}, 1000);

	var sendReq = function(params, callback) {
		$.post(url, params, function(data) {
			callback(data);
		})
	}

	var setToday = function(){
		var today = new Date();
		var dd = today.getDate();
		var mm = today.getMonth() + 1; //January is 0!
		var yyyy = today.getFullYear();
		if(dd < 10) {
    		dd = '0' + dd
		} 
		if(mm < 10) {
		    mm = '0' + mm
		} 
		var today = yyyy+'-'+mm+'-'+dd;
		var today = yyyy + '-' + mm + '-' + dd;
		$("#start").val(today);
	}

	var url = "handler.php";
	sendReq({action: "getUsers", event: localStorage.getItem('event')}, function(data){
		if(data[0] == '['){
			users = JSON.parse(data);
			for(var i in users) {
				var firstname = users[i].first_name;
				var lastname= users[i].last_name;
				var middlename = users[i].middle_name;
				var lfm = lastname+' '+firstname+' '+middlename;
				LFM.push(lfm);
			}
		}
		else
			alert(data);
	});


	var url = "handler.php";
	sendReq({action: "getRooms"}, function(data) {
		var s = ''; 
		var res = JSON.parse(data);
		for(var i in res) {
			console.log(res[i]);
			var f=m=0;
			for(var j in res[i].users) {
				sex = res[i].users[j].sex;
				if(sex == 'f') {
					f++;
				}
				if(sex == 'm') {
					m++;
				}
			}

			var mNum = m * 100 / res[i].max;
			var fNum = f * 100 / res[i].max;
			var free = res[i].max - res[i].users.length;
			var percentBusy = (m + f) * 100 / res[i].max;
			var percentFree = 100 - percentBusy;
			s += 
			'<div data-id="' + i + '" class="item">'+
				'<div>'+ res[i].id_app  + ' | ' +
					res[i].room_num + ' | ' +
					'Мест: ' + res[i].max + ' | Занято: ' + res[i].users.length + 
				'</div>'+
				'<div class="progress">'+
					'<div class="progress-bar progress-bar-info" role="progressbar" style="width:'+mNum+'%">'+
	   				 	m+
	  				'</div>'+
 				 	'<div class="progress-bar progress-bar-danger" role="progressbar" style="width:'+fNum+'%">'+
   						f+
  					'</div>'+
  					 	'<div class="progress-bar progress-bar-success" role="progressbar" style="width:'+percentFree+'%">'+
   						free+
  					'</div>'+
				'</div>'+
			'</div>';
		}
		$("#roomsList").html(s);
		$(".item").on("click", function() {
			var self = $( this );
			var i = self.attr("data-id");
			console.log(i);
			if(res[i]["max"] > res[i]["num"]) 
			{
				$(".bg-success").removeClass("bg-success");
				self.addClass("bg-success");
				result.id_app = res[i]["id_app"];
			}
		})
	})


	var sendData = function() {
		fio = $( "#lfm" ).val();
		var res = window.fio;
		console.log(res);
		var arr = res.split(' ');
		result.lastname = arr[0];
		result.firstname = arr[1];
		result.middlename = arr[2];
		var start = $("#start").val();
		var end = $("#end").val();
		sendReq({action: "lodge",
			id_app: result.id_app, 
			lastname: result.lastname, 
			firstname: result.firstname, 
			middlename: result.middlename, 
			start: start, 
			end: end},
			function(data) {
				if(data)
					alert(data)
				else {
					status = status | 32;
					localStorage.setItem("status", status);
					window.location.href = "makebage.html";
				}
			});
	};

</script>
</body>
</html>